<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sist.repository.mappers.post">


    <select id="do_searchOne" 
      parameterType= "project.mc.blog.post.domain.PostDTO"
      resultType= "project.mc.blog.post.domain.PostDTO">
      SELECT post_id,
		  blog_id,
		  sup_post_id,
		  post_title,
		  post_content,
		  reg_id,
		  to_char(reg_dt,'YYYY-MM-DD') as reg_dt,
		  MOD_ID,
		  to_char(reg_dt,'YYYY-MM-DD') as mod_dt,
		  del_flag
		FROM mc_post
		where post_id=#{post_id}
    </select>  
	
	<update id="do_update" parameterType="project.mc.blog.post.domain.PostDTO">
	
	UPDATE MC_POST
	SET
	      blog_id      = #{blog_id , jdbcType=INTEGER},
	      post_title   = #{post_title , jdbcType=VARCHAR},
	      post_content = #{post_content , jdbcType=CLOB},
	      mod_id       = #{mod_id , jdbcType=VARCHAR},
	      mod_dt       = SYSDATE
	WHERE post_id      = #{post_id , jdbcType=INTEGER}
	</update>
	
	<delete id="do_delete"  
	parameterType="project.mc.blog.post.domain.PostDTO">
	   DELETE FROM mc_post
        WHERE post_id = #{post_id}   
	</delete>
	
	<update id="do_save"  
	   parameterType="project.mc.blog.post.domain.PostDTO">
	   INSERT
		INTO mc_post
		  (
		    post_id,
		    blog_id,
		    post_title,
		    post_content,
		    reg_id
		  )
	  VALUES
	  (seq_post_id.NEXTVAL, #{blog_id}, #{post_title}, #{post_content}, #{reg_id})
	   				
	</update>     
    
    <sql id="userSearchCondition">    
       <where>   
        <choose>
            <when test="SEARCH_DIV == '10'">
                 A.post_title LIKE  #{search_word} || '%'         
            </when>
            <when test="SEARCH_DIV == '20'">
                AND A.post_content LIKE  #{search_word} || '%'     
            </when>
                        
            <otherwise></otherwise>
        </choose>
        </where>       
    </sql>
        
	<select id="do_search" 
	      parameterType="project.mc.blog.post.domain.PostDTO"
	      resultType="project.mc.blog.post.domain.PostDTO">
	      
	SELECT  T1.post_id,
	        T1.blog_id,
	        T1.sup_post_id,
	        T1.post_title,
	        T1.post_content,
	        T1.reg_id,
	        TO_CHAR(T1.reg_dt, 'YYYY-MM-DD') AS reg_dt,
	        T1.mod_id,
	        TO_CHAR(T1.mod_dt, 'YYYY-MM-DD') AS mod_dt,
	        T1.del_flag
	FROM (select A.*                                               
		           ,ROW_NUMBER() OVER(ORDER BY A.reg_dt DESC) as rnum
		           ,COUNT(*) OVER () AS total_cnt                     
		      from mc_post A 
		      <include refid="userSearchCondition" />  
    	<![CDATA[         
			 order by reg_dt desc  
	      )T1
	 WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) AND (#{page_size} * (#{page_num}-1)+#{page_size})      
	 ]]>	
	 
	</select>      
</mapper>